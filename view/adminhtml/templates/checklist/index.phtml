<?php
/**
 * Mageplaza
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the mageplaza.com license that is
 * available through the world-wide-web at this URL:
 * https://www.mageplaza.com/LICENSE.txt
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category    Mageplaza
 * @package     Mageplaza_Security
 * @copyright   Copyright (c) 2018 Mageplaza (https://www.mageplaza.com/)
 * @license     https://www.mageplaza.com/LICENSE.txt
 */
?>

<?php
$unSecureNames = $block->checkAdminUserName();
?>
<div class="box box-<?php echo empty($unSecureNames) ? 'green' : 'red'; ?>">
    <div class="box-header with-border">
        <strong><?php echo __("Check admin's username:"); ?></strong>
    </div>
    <div class="username-notice">
        <p><?php echo __("The following usernames are not secured: %1.", 'admin, root, test, magento'); ?></p>
        <p><?php echo __("Hackers can guest username easily. Click on an user to change username."); ?></p>
    </div>
    <div class="err-nof">
        <?php if (!empty($unSecureNames)): ?>
            <?php foreach ($unSecureNames as $unSecureName): ?>
                <div class="err-nof-line">
                    <i class="fa fa-remove"></i>
                    <span><?php echo __('Username: "%1" is not secure.', $unSecureName['username']); ?></span>
                    <a href="<?php echo $block->getUserNameFixitUrl($unSecureName) ?>" target="_blank" class="fix-it"><?php echo __('Fix it') ?></a>
                </div>
            <?php endforeach; ?>
        <?php else: ?>
            <i class="fa fa-check"></i>
            <span><?php echo __("All users are adequate for security purposes"); ?></span>
        <?php endif; ?>
    </div>
</div>
<div class="box box-<?php echo (!$block->checkFrontendCaptcha() && !$block->checkBackendCaptcha()) ? 'red' : 'green'; ?>">
    <div class="box-header with-border">
        <strong><?php echo __("Check captcha:"); ?></strong>
    </div>
    <div class="err-nof">
        <p>
            <?php if (!$block->checkFrontendCaptcha()): ?>
                <i class="fa fa-remove"></i>
                <span><?php echo __("Frontend captcha is not enabled. Hackers may carry out brute-force attacks on your customers' accounts"); ?></span>
                <a href="<?php echo $block->getFrontendCaptchaFixitUrl() ?>" class="fix-it"><?php echo __('Fix it') ?></a>
            <?php else: ?>
                <i class="fa fa-check"></i>
                <span><?php echo __("Frontend captcha is enabled."); ?></span>
            <?php endif; ?>
        </p>
        <?php if (!$block->checkBackendCaptcha()): ?>
            <div class="err-nof-line">
                <p>
                    <i class="fa fa-remove"></i>
                    <span><?php echo __("Backend captcha is not enabled. To protect your backend from brute-force attacks, you should enable it."); ?></span>
                    <a href="<?php echo $block->getBackendCaptchaFixitUrl() ?>" class="fix-it"><?php echo __('Fix it') ?></a>
                </p>
            </div>
        <?php else: ?>
            <p>
                <i class="fa fa-check"></i>
                <span><?php echo __("Backend captcha is enabled."); ?></span>
            </p>
        <?php endif; ?>
    </div>
</div>
<?php
$version  = $block->checkLatestVersion();
$isLatest = $version['latestVer'] == $version['currentVersion'];
?>
<div class="box box-<?php echo $isLatest ? 'green' : 'red'; ?>">
    <div class="box-header with-border">
        <strong><?php echo __("Check Magento Version:"); ?></strong>
    </div>
    <div class="err-nof">
        <?php if (!$isLatest) : ?>
            <div class="err-nof-line">
                <i class="fa fa-remove"></i>
                <span>
                    <?php echo __("Your Magento version is: %1, the latest version is: %2", $version['currentVersion'], $version['latestVer']); ?>
                    <a href="<?php echo $block->getVersionFixitUrl() ?>" target="_blank" class="fix-it"><?php echo __('Upgrade') ?></a>
                </span>
            </div>
        <?php else: ?>
            <i class="fa fa-check"></i>
            <span><?php echo __("Your store is running on the latest version."); ?></span>
        <?php endif; ?>
    </div>
</div>
<?php $dbPrefix = $block->getDatabasePrefix() ?>
<div class="box box-<?php echo $dbPrefix ? 'green' : 'red'; ?>">
    <div class="box-header with-border">
        <strong><?php echo __("Check database prefix:"); ?></strong>
    </div>
    <div class="err-nof">
        <?php if ($dbPrefix): ?>
            <i class="fa fa-check"></i>
            <span><?php echo __("Your store's database is good."); ?></span>
        <?php else: ?>
            <div class="err-nof-line">
                <i class="fa fa-remove"></i>
                <span>
                    <?php echo __("Your store’s database hasn’t got table prefixes."); ?>
                    <a id="db-prefix" class="fix-it"><?php echo __('Fix it') ?></a>
                    <?php echo $block->getDbFixitAdditionData() ?>
                </span>
            </div>
        <?php endif; ?>
    </div>
</div>

<script>
    <?php if(!$block->hasProPackage()): ?>
    require([
        'jquery'
    ], function ($) {
        var notice = "<?php echo __('Please update to %1 edition to have these issues solved automatically.', '<a href=\'http://www.mageplaza.com/magento-2-security/\' target=\'_blank\'>SecurityPro</a>'); ?>";

        $('.fix-it').each(function () {
            $(this).click(function (e) {
                e.stopPropagation();
                e.preventDefault();

                if (!$(this).parent().find('.checklist-notification').length) {
                    $(this).parent().append('<div class="checklist-notification">' + notice + '</div>');
                    $('body').click(function (e) {
                        if (!$(e.target).closest('.checklist-notification').length && !$(e.target).closest('.fix-it').length) {
                            $('.checklist-notification').remove();
                        }
                    });
                }
            });
        });
    });
    <?php endif; ?>

    <?php echo $block->getAdditionalJavascript() ?>
</script>
